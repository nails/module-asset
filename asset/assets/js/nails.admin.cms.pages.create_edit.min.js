var NAILS_Admin_CMS_pages_Create_Edit;NAILS_Admin_CMS_pages_Create_Edit=function(){this._api=null,this.editor_id=Math.floor(1e16*Math.random()),this._editor={},this.search_placeholder="Search widget library",this.templates=[],this.mustache_tpl={},this.widgets=[],this.page_data={},this._dragging_widget=!1,this._editor_open=!1,this._preview_open=!1,this._dialog_open=!1,this._saving=!1,this._refreshing=!1,this._async_save=!0,this.init=function(t,e,i,a){this.templates=t,this.widgets=e,this._api=new window.NAILS_API;var s,o;if("undefined"==typeof a||null===a){this.page_data={hash:null,id:"undefined"!=typeof i?i:null,data:{},widget_areas:{}};for(s in this.templates){this.page_data.widget_areas[s]={};for(o in this.templates[s].widget_areas)this.page_data.widget_areas[s][o]=[]}this._refresh_page_data()}else{this.page_data=a,this.page_data.id=i;for(s in this.templates){"undefined"==typeof this.page_data.widget_areas&&(this.page_data.widget_areas={}),"undefined"==typeof this.page_data.widget_areas[s]&&(this.page_data.widget_areas[s]={});for(o in this.templates[s].widget_areas)"undefined"==typeof this.page_data.widget_areas[s][o]&&(this.page_data.widget_areas[s][o]=[])}}this.page_data.hash=this._generate_data_hash(),"function"==typeof console.log&&console.log("CMS PAGES: Initial page_data:",this.page_data),this._template_chooser_init(),this._editor_init();var d=this;window.onbeforeunload=function(){return d._needs_saved()!==!1?"You have unsaved changes. Are you sure you want to leave?":void 0},$(document).on("click","a.main-action",function(t){if($(this).hasClass("disabled"))return!1;var e=$(this).data("action");switch(d._disable_main_actions(),e){case"save":d._main_action_save();break;case"publish":d._main_action_publish();break;case"preview":d._main_action_launch_preview();break;default:"function"==typeof console.warn&&console.warn("CMS PAGES: Uncaught main-action."),d._enable_main_actions()}return t.stopPropagation(),!1})},this._enable_main_actions=function(){$("a.main-action").removeClass("disabled"),$("p.actions").removeClass("loading")},this._disable_main_actions=function(){$("a.main-action").addClass("disabled"),$("p.actions").addClass("loading")},this._main_action_save=function(){var t=this,e=function(e){t._redirect(window.SITE_URL+"admin/cms/pages/edit/"+e.id+"?message=saved")},i=function(e){t._enable_main_actions(),$("<div>").text(e.error).dialog({title:"Something went wrong.",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("close")}},open:function(){t._dialog_open=!0},close:function(){setTimeout(function(){t._dialog_open=!1},500)}})};t._save(e,i,!0)},this._main_action_publish=function(){var t=this,e=function(e){t._redirect(window.SITE_URL+"admin/cms/pages/edit/"+e.id+"?message=published")},i=function(e){t._enable_main_actions(),$("<div>").text(e.error).dialog({title:"Something went wrong.",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("close")}},open:function(){t._dialog_open=!0},close:function(){setTimeout(function(){t._dialog_open=!1},500)}})};t._save(e,i,!0,!0)},this._main_action_launch_preview=function(){this._editor.container.addClass("loading"),this._preview_open=!0;var t=this,e=function(e){t._editor.container.removeClass("loading"),$.fancybox({type:"iframe",href:window.SITE_URL+"cms/render/preview/"+e.id,width:"90%",height:"90%",iframe:{preload:!1},afterClose:function(){t._preview_open=!1,t._enable_main_actions()}})},i=function(e){t._editor.container.removeClass("loading"),t._dialog_open=!0,$("<div>").text(e.error).dialog({title:"Something went wrong.",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("close")}},open:function(){t._dialog_open=!0},close:function(){setTimeout(function(){t._dialog_open=!1},500)}}),t._preview_open=!1,t._enable_main_actions()};this._save_preview(e,i,!0)},this._save=function(t,e,i,a){if(this._saving)return"function"==typeof console.log&&console.log("CMS PAGES: Save in progress, ignoring repeated call."),!1;if(this._refreshing)return"function"==typeof console.log&&console.log("CMS PAGES: Refresh in progress, ignoring repeated call."),!1;var s=this._needs_saved();if(s!==!1||i){i!==!0?"function"==typeof console.log&&console.log("CMS PAGES: Data has changed, old hash: "+this.page_data.hash+", new hash: "+s+" - Saving..."):"function"==typeof console.log&&console.log("CMS PAGES: Forced save requested. Saving... old hash: "+this.page_data.hash+", new hash: "+s+" - Saving..."),s!==!1&&(this.page_data.hash=s),this._saving=!0,$("#save-status").removeClass("message").addClass("saving notice").show(),$("#save-status .last-saved").text("Saving...");var o;o=a===!0?"PUBLISH":"NONE";var d={controller:"cms/pages",method:"save",action:"POST",async:this._async_save,data:{page_data:JSON.stringify(this.page_data),publish_action:o},success:$.proxy(function(e){this._save_ok(t,e)},this),error:$.proxy(function(t){this._save_fail(e,t)},this)};return this._api.call(d),!0}return"function"==typeof console.log&&console.log("CMS PAGES: Page data hasn't changed, ignoring call"),!1},this._save_ok=function(t,e){if(200===e.status){this.page_data.id=e.id,this.page_data.hash=this._generate_data_hash(),$("#save-status").removeClass("saving");var i=new Date,a=i.getHours()<10?"0"+i.getHours():i.getHours(),s=i.getMinutes()<10?"0"+i.getMinutes():i.getMinutes(),o=a+":"+s;$("#save-status .last-saved").text(o),"function"==typeof console.log&&console.log("CMS PAGES: Save completed successfully")}else $("#save-status").removeClass("saving notice").addClass("message"),$("#save-status .last-saved").text("ERROR: "+e.error),"function"==typeof console.log&&console.log("CMS PAGES: Save failed: "+e.error);this._saving=!1,"function"==typeof t&&t.call(void 0,e)},this._save_fail=function(t,e){var i;try{i=JSON.parse(e.responseText)}catch(a){i={}}$("#save-status").removeClass("saving notice").addClass("message"),$("#save-status .last-saved").text("ERROR: "+i.error),"function"==typeof console.log&&console.log("CMS PAGES: Save failed: "+i.error),this._saving=!1,"function"==typeof t&&t.call(void 0,i)},this._save_preview=function(t,e){if(this._saving_preview)return"function"==typeof console.log&&console.log("CMS PAGES: Save (Preview) in progress, ignoring repeated call."),!1;this._saving_preview=!0,this._refresh_page_data(),this.page_data.hash=this._generate_data_hash();var i={controller:"cms/pages",method:"save",action:"POST",async:this._async_save,data:{page_data:JSON.stringify(this.page_data),generate_preview:!0},success:$.proxy(function(e){this._save_preview_ok(t,e)},this),error:$.proxy(function(t){this._save_preview_fail(e,t)},this)};this._api.call(i)},this._save_preview_ok=function(t,e){this._saving_preview=!1,"function"==typeof t&&t.call(void 0,e)},this._save_preview_fail=function(t,e){var i;try{i=JSON.parse(e.responseText)}catch(a){i={}}this._saving_preview=!1,"function"==typeof t&&t.call(void 0,i)},this._needs_saved=function(){var t=this._generate_data_hash();return this.page_data.hash!==t?t:!1},this._refresh_page_data=function(){this._refreshing=!0,this.page_data.data.title=$("<div />").text($("input[name=title]").val()).html(),this.page_data.data.is_published=$("input[name=is_published]").val();var t=$("select[name=parent_id]");if(this.page_data.data.parent_id=1===t.length?t.val():$("input[name=parent_id]").val(),this.page_data.data.seo_title=$("input[name=seo_title]").val(),this.page_data.data.seo_description=$("input[name=seo_description]").val(),this.page_data.data.seo_keywords=$("input[name=seo_keywords]").val(),this.page_data.data.template=$("input[name=template]:checked").val(),this.page_data.data.additional_fields=$(":input[name^=additional_field]").serialize(),this._editor_open){var e=this,i=this._editor.dropzone.data("template"),a=this._editor.dropzone.data("area");"undefined"==typeof this.page_data.widget_areas[i]&&(this.page_data.widget_areas[i]={}),this.page_data.widget_areas[i][a]=[],this._editor.dropzone.find("li.processed.dropzone-widget").each(function(){var t={widget:$(this).data("slug"),data:$(this).find("form.editor").serialize()};e.page_data.widget_areas[i][a].push(t)})}this._refreshing=!1},this._generate_data_hash=function(){this._refresh_page_data();var t={data:{},widget_areas:{}};return $.extend(t.data,this.page_data.data),$.extend(t.widget_areas,this.page_data.widget_areas),this.md5(JSON.stringify(t))},this._template_chooser_init=function(){$("label.template").on("click",function(){$("label.template").removeClass("selected"),$(this).addClass("selected");var t=$(this).data("template-slug");$("a.launch-editor").hide(),$("a.launch-editor.template-"+t).show(),$(".additional-fields").hide(),$("#additional-fields-"+t).show()})},this._editor_init=function(){var t=this;this.mustache_tpl.loader=$("#template-loader").html(),this.mustache_tpl.widget_search=$("#template-widget-search").html(),this.mustache_tpl.dropzone_empty=$("#template-dropzone-empty").html(),this.mustache_tpl.widget_grouping=$("#template-widget-grouping").html(),this.mustache_tpl.widget=$("#template-widget").html(),this.mustache_tpl.header=$("#template-header").html(),this.mustache_tpl.dropzone_empty=$("#template-dropzone-empty").html(),this.mustache_tpl.dropzone_widget=$("#template-dropzone-widget").html(),this._editor.container=$("<div>").attr("id",this.editor_id).addClass("group-cms pages widgeteditor ready"),this._editor.loader=$("<div>").attr("id",this.editor_id+"-loader").addClass("loader").html(this.mustache_tpl.loader),this._editor.header=$("<ul>").attr("id",this.editor_id+"-header").addClass("header"),this._editor.widgets=$("<ul>").attr("id",this.editor_id+"-widgets").addClass("widgets").disableSelection(),this._editor.widgets_search=$("<li>").attr("id",this.editor_id+"-search").addClass("search").html(this.mustache_tpl.widget_search),this._editor.dropzone=$("<ul>").attr("id",this.editor_id+"-dropzone").addClass("dropzone empty").html(this.mustache_tpl.dropzone_empty),this._editor.widgets.append(this._editor.widgets_search);var e,i,a,s,o,d,r;e=0,i=this.mustache_tpl.widget_grouping,a=this.mustache_tpl.widget;for(var n in this.widgets){s={name:this.widgets[n].label,group:"group-"+e},o=Mustache.render(i,s),this._editor.widgets.append(o);for(var h in this.widgets[n].widgets)s={group:"group-"+e,name:this.widgets[n].widgets[h].label,description:this.widgets[n].widgets[h].description,keywords:this.widgets[n].widgets[h].keywords,slug:this.widgets[n].widgets[h].slug},o=Mustache.render(a,s),this._editor.widgets.append(o),d="var _WIDGET_CALLBACKS_"+this.widgets[n].widgets[h].slug+" = function(){",d+="this.dropped = function( ui ){",this.widgets[n].widgets[h].callbacks.dropped.length>0&&(d+=this.widgets[n].widgets[h].callbacks.dropped),d+="var _textarea	= ui.find( 'textarea.wysiwyg' );",d+="$.each( _textarea, function( index )",d+="{",d+="	var _id = ui.attr( 'id' ) + '-wysiwyg-' + index;",d+="	$(this).attr( 'id', _id );",d+="	$(this).ckeditor(",d+="	{",d+="		customConfig: window.NAILS.URL + 'libraries/ckeditor/ckeditor.config.min.js'",d+="	},",d+="	function()",d+="	{",d+="		var _header_height	= ui.find( '.header-bar' ).outerHeight();",d+="		var _editor_height	= ui.find( '.editor' ).outerHeight();",d+="		var _height			= _header_height + _editor_height;",d+="		if ( ui.css( 'box-sizing' ) === 'border-box' )",d+="		{",d+="			_height = _height + ( 2 * parseInt( ui.css( 'border-width' ), 10 ) );",d+="		}",d+="		ui.stop().animate( { height: _height }, 250 );",d+="	});",d+="	CKEDITOR.instances[_id].on( 'autoGrow', function( e )",d+="	{",d+="		var _difference		= e.data.newHeight - e.data.currentHeight;",d+="		var _header_height	= ui.find('.header-bar').outerHeight();",d+="		var _editor_height	= ui.find('.editor').outerHeight();",d+="		var _height			= _header_height + _editor_height + _difference;",d+="		ui.css({height:_height});",d+="	});",d+="});",d+="ui.find( 'select.select2' ).select2();",d+="};",d+="this.sort_start = function( ui ){",this.widgets[n].widgets[h].callbacks.sort_start.length>0&&(d+=this.widgets[n].widgets[h].callbacks.sort_start),d+="var _textarea = ui.find( 'textarea.wysiwyg' );",d+="if ( _textarea.length > 0 )",d+="{",d+="	$.each( _textarea, function( index )",d+="	{",d+="		var _id = ui.attr( 'id' ) + '-wysiwyg-' + index;console.log(_id);",d+="		CKEDITOR.instances[_id].destroy();",d+="	});",d+="	var _mask = ui.find( '.mask' );",d+="	if ( _mask.length === 0 )",d+="	{",d+="		_mask = $( '<div>' ).addClass( 'mask' ).text( '"+this.widgets[n].widgets[h].label+" widget disabled while sorting.' );",d+="		ui.prepend( _mask );",d+="	}",d+="	ui.addClass( 'sorting' );",d+="	_mask.animate( { opacity: 1 }, 150 );",d+="}",d+="};",d+="this.sort_stop = function( ui ){",this.widgets[n].widgets[h].callbacks.sort_stop.length>0&&(d+=this.widgets[n].widgets[h].callbacks.sort_stop),d+="var _textarea	= ui.find( 'textarea.wysiwyg' );",d+="$.each( _textarea, function( index )",d+="{",d+="	var _id = ui.attr( 'id' ) + '-wysiwyg-' + index;",d+="	$(this).attr( 'id', _id );",d+="	$(this).ckeditor(",d+="	{",d+="		customConfig: window.NAILS.URL + 'libraries/ckeditor/ckeditor.config.min.js'",d+="	},",d+="	function()",d+="	{",d+="		var _header_height	= ui.find( '.header-bar' ).outerHeight();",d+="		var _editor_height	= ui.find( '.editor' ).outerHeight();",d+="		var _height			= _header_height + _editor_height;",d+="		if ( ui.css( 'box-sizing' ) === 'border-box' )",d+="		{",d+="			_height = _height + ( 2 * parseInt( ui.css( 'border-width' ), 10 ) );",d+="		}",d+="		ui.stop().animate( { height: _height }, 250 );",d+="	});",d+="	CKEDITOR.instances[_id].on( 'autoGrow', function( e )",d+="	{",d+="		var _difference		= e.data.newHeight - e.data.currentHeight;",d+="		var _header_height	= ui.find('.header-bar').outerHeight();",d+="		var _editor_height	= ui.find('.editor').outerHeight();",d+="		var _height			= _header_height + _editor_height + _difference;",d+="		ui.css({height:_height});",d+="	});",d+="});",d+="ui.find( '.mask' ).animate( { opacity: 0 }, 150, function()",d+="{",d+="	ui.removeClass( 'sorting' );",d+="});",d+="};",d+="this.remove_start = function( ui ){",this.widgets[n].widgets[h].callbacks.remove_start.length>0&&(d+=this.widgets[n].widgets[h].callbacks.remove_start),d+="var _textarea = ui.find( 'textarea.wysiwyg' );",d+="$.each( _textarea, function( index )",d+="{",d+="	var _id = ui.attr( 'id' ) + '-wysiwyg-' + index;",d+="	CKEDITOR.instances[_id].destroy();",d+="});",d+="};",d+="this.remove_stop = function( ui ){",this.widgets[n].widgets[h].callbacks.remove_stop.length>0&&(d+=this.widgets[n].widgets[h].callbacks.remove_stop),d+="};",d+="this.resize_widget = function( ui ){",d+="var _header_height	= ui.find( '.header-bar' ).outerHeight();",d+="var _editor_height	= ui.find( '.editor' ).outerHeight();",d+="var _height			= _header_height + _editor_height;",d+="if ( ui.css( 'box-sizing' ) === 'border-box' )",d+="{",d+="_height = _height + ( 2 * parseInt( ui.css( 'border-width' ), 10 ) );",d+="}",d+="ui.animate({height:_height},250);",d+="};",d+="};",d+="var _WIDGET_"+this.widgets[n].widgets[h].slug+" = new _WIDGET_CALLBACKS_"+this.widgets[n].widgets[h].slug+"();",r=$("<script>").attr("id","callbacks-"+this.widgets[n].widgets[h].slug).attr("type","text/javascript").html(d),$("body").append(r);e++}this._editor.container.append(this._editor.loader),this._editor.container.append(this._editor.header),this._editor.container.append(this._editor.dropzone),this._editor.container.append(this._editor.widgets),$("body").append(this._editor.container),$("a.launch-editor").on("click",function(){var e=$(this).data("template"),i=$(this).data("area");return t._editor_launch(e,i),!1}),$('li.widget[title!=""]',this._editor.widgets).tipsy({gravity:"w"})},this._editor_launch=function(t,e){$("#"+this.editor_id).removeClass("ready").addClass("loading").show(),$("body").addClass("noscroll"),this._load_widgets_for_area(t,e),this._editor_construct(t,e),$("#"+this.editor_id).addClass("ready").removeClass("loading")},this._editor_construct=function(t,e){var i=this;this._editor.dropzone.data("template",t),this._editor.dropzone.data("area",e);var a,s;a=this._get_template(t),a.active_area=a.widget_areas[e].title,s=this.mustache_tpl.header,s=Mustache.render(s,a),this._editor.header.html(s),this._editor.dropzone.sortable({placeholder:"placeholder",handle:".sorter",start:function(t,e){if(e.placeholder.height(e.helper.height()),e.item.hasClass("processed")){var i=e.item.data("slug");try{window["_WIDGET_"+i].sort_start(e.item)}catch(a){"function"==typeof console.log&&console.log('CMS PAGES: `sort_start` callback is not defined for widget "'+i+'"',a)}}},update:function(t,e){e.item.hasClass("processed")||i._drop_widget(a.slug,e.item)},over:function(){i._editor.dropzone.removeClass("empty"),i._editor.dropzone.find("li.empty").remove()},out:function(){var t=0;if(t+=i._editor.dropzone.find("li.dropzone-widget").length,t+=i._editor.dropzone.find("li.widget").length,1>=t){var e=i.mustache_tpl.dropzone_empty;i._editor.dropzone.addClass("empty").append(e)}},stop:function(t,e){if(i._editor.dropzone.find("li.dropzone-widget").length<=0){var a=i.mustache_tpl.dropzone_empty;i._editor.dropzone.addClass("empty").append(a)}else i._editor.dropzone.removeClass("empty"),i._editor.dropzone.find("li.empty").remove();if(e.item.hasClass("processed")){var s=e.item.data("slug");try{window["_WIDGET_"+s].sort_stop(e.item)}catch(o){"function"==typeof console.log&&console.log('CMS PAGES: `sort_stop` callback is not defined for widget "'+s+'"',o)}}}});var o="This widget has been disabled for this template/area.";for(var d in this.widgets)for(var r in this.widgets[d].widgets)this.widgets[d].widgets[r].restrict_to_template.length&&this._array_search(t,this.widgets[d].widgets[r].restrict_to_template)===!1&&this._editor.widgets.find("li.widget."+this.widgets[d].widgets[r].slug).addClass("disabled").data("original-title",o).attr("title",o),this.widgets[d].widgets[r].restrict_to_area.length&&this._array_search(e,this.widgets[d].widgets[r].restrict_to_area)===!1&&this._editor.widgets.find("li.widget."+this.widgets[d].widgets[r].slug).addClass("disabled").data("original-title",o).attr("title",o),this.widgets[d].widgets[r].restrict_from_template.length&&this._array_search(t,this.widgets[d].widgets[r].restrict_from_template)!==!1&&this._editor.widgets.find("li.widget."+this.widgets[d].widgets[r].slug).addClass("disabled").data("original-title",o).attr("title",o),this.widgets[d].widgets[r].restrict_from_area.length&&this._array_search(e,this.widgets[d].widgets[r].restrict_from_area)!==!1&&this._editor.widgets.find("li.widget."+this.widgets[d].widgets[r].slug).addClass("disabled").data("original-title",o).attr("title",o);this._editor.widgets.find("li.widget:not(.disabled)").draggable({helper:function(t){var e=$(t.currentTarget);return $("<div>").addClass("dragging-widget").text(e.data("title"))},appendTo:"#"+this.editor_id,zIndex:3,connectToSortable:this._editor.dropzone,start:function(){i._dragging_widget=!0},stop:function(){i._dragging_widget=!1}}),$(document).on("keyup",function(t){i._dragging_widget||i._preview_open||i._dialog_open||27!==t.keyCode||i._editor_close()}),this._editor.widgets_search.find("a.minimiser").on("click",function(){$("#"+i.editor_id).toggleClass("minimised")}),this._editor.widgets_search.find("input").on("keyup",function(){var t=$.trim($(this).val());t.length>0?i._editor.widgets.find("li.widget").each(function(){var e=$(this).data("keywords").split(","),i=new RegExp(t,"gi");i.test(e)?($(this).addClass("search-hit"),$(this).removeClass("search-miss")):($(this).addClass("search-miss"),$(this).removeClass("search-hit"))}):i._editor.widgets.find("li.widget").removeClass("search-miss search-hit")}),this._editor.widgets.find("li.grouping").on("click",function(){$(this).toggleClass("open");var t=$(this).data("group");i._editor.widgets.find("li.widget."+t).toggleClass("hidden")}),i._editor.header.find("ul.rhs a.action").on("click",function(){var t=$(this).data("action");switch(t){case"close":i._editor_close()}return!1}),this._editor_open=!0},this._editor_destruct=function(){this._refresh_page_data(),$("body").removeClass("noscroll"),this._editor.widgets.find("li.widget:not(.disabled)").draggable("destroy"),this._editor.widgets.find("li.dropzone").sortable("destroy"),this._editor.widgets.find("li.widget.disabled").removeClass("disabled").data("original-title","").attr("title",""),$(document).off("keyup"),this._editor.widgets_search.find("a.minimiser").off("click"),this._editor.widgets_search.find("input").off("keyup"),this._editor.widgets.find("li.grouping").off("click"),this._editor.header.find("ul.rhs a").off("click"),this._editor.dropzone.data("template",""),this._editor.dropzone.data("area",""),this._editor_open=!1},this._load_widgets_for_area=function(t,e){var i=this.mustache_tpl.dropzone_empty;if(this._editor.dropzone.addClass("empty").html(i),"undefined"!=typeof this.page_data.widget_areas[t][e]&&this.page_data.widget_areas[t][e].length){this._editor.dropzone.removeClass("empty"),this._editor.dropzone.find("li.empty").remove();for(var a in this.page_data.widget_areas[t][e]){var s=this.page_data.widget_areas[t][e][a],o=$("<div>").data("slug",s.widget);this._editor.dropzone.append(o),this._drop_widget(t,o,s.data)}}},this._drop_widget=function(t,e,i){var a,s,o,d,r;if(a=$(e).data("slug"),s=this._get_widget(a),s!==!1){o={id:"widget-editor-"+Math.floor(1e16*Math.random()),slug:a,label:s.label,description:s.description},d=Mustache.render(this.mustache_tpl.dropzone_widget,o),r=$("<li>"),r.addClass("processed dropzone-widget "+o.slug),0===o.description.length&&r.addClass("mask-no-description"),r.attr("id",o.id),r.data("slug",o.slug),r.html(d);var n=this;$(".header-bar .closer",r).on("click",function(t){var e=$(this).closest("li.dropzone-widget").attr("id");return n._remove_widget(e),t.stopPropagation(),!1}),e.replaceWith(r),this._editor.dropzone.removeClass("empty"),this._editor.dropzone.find("li.empty").remove();var h={action:"POST",controller:"cms/pages",method:"widget/get_editor",data:{widget:s.slug,template:t,id:o.id,data:i},success:function(t){$(r).find(".editor").html(t.HTML),"function"==typeof _nails.add_stripes&&_nails.add_stripes(),"function"==typeof $.fn.select2;try{window["_WIDGET_"+s.slug].dropped(r)}catch(e){"function"==typeof console.log&&console.log('CMS PAGES: `dropped` callback is not defined for widget "'+s.slug+'"',e)}try{window["_WIDGET_"+s.slug].resize_widget(r)}catch(e){"function"==typeof console.log&&console.log('CMS PAGES: `resize_widget` callback is not defined for widget "'+s.slug+'"',e)}n._refresh_page_data()},error:function(t){var e=JSON.parse(t.responseText);$(r).addClass("error").find(".editor").html('<p class="system-alert error"><strong>Error:</strong> '+e.error+"</p>")}};this._api.call(h)}else{"function"==typeof console.warn&&console.warn('CMS PAGES: Could not find widget "'+a+'"; ignored.');var _="";_+='<p>I just attempted, and failed, to load a widget whose slug was "'+a+'"</p>',_+="<p>This likely happened due to an out-of-date database or a 3rd party edited the database with bad data.</p>",_+="<p>While nothing dangerous has happened, you should know that this widget was not loaded. You should check that your page is as expected.</p>",$("<div>").html(_).dialog({title:"A widget could not be loaded",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("close")}}})}},this._remove_widget=function(t){var e=this;$("<div>").text("Are you sure you wish to remove this widget from the interface?").dialog({title:"Are you sure?",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){var i=$("#"+t),a=i.data("slug");try{window["_WIDGET_"+a].remove_start(i)}catch(s){"function"==typeof console.log&&console.log('NAILS CMS PAGES: `remove_start` callback is not defined for widget "'+a+'"',s)}$(this).dialog("close"),i.animate({opacity:0,height:0},250,function(){if(i.remove(),e._editor.dropzone.find("li.dropzone-widget").length<=0){var t=e.mustache_tpl.dropzone_empty;e._editor.dropzone.addClass("empty").append(t).find("li.empty").css({opacity:0}).animate({opacity:1},250)}try{window["_WIDGET_"+a].remove_stop(i)}catch(s){"function"==typeof console.log&&console.log('CMS PAGES: `remove_stop` callback is not defined for widget "'+a+'"',s)}})},Cancel:function(){$(this).dialog("close")}},open:function(){e._dialog_open=!0},close:function(){setTimeout(function(){e._dialog_open=!1},500)}}),$(".ui-widget-overlay").css({zIndex:1e3})},this._editor_close=function(){$("#"+this.editor_id).hide(),this._editor_destruct()},this._get_template=function(t){for(var e in this.templates)if(t===this.templates[e].slug)return this.templates[e];return!1},this._get_widget=function(t){for(var e in this.widgets)for(var i in this.widgets[e].widgets)if(t===this.widgets[e].widgets[i].slug)return this.widgets[e].widgets[i];return!1},this._redirect=function(t){window.onbeforeunload=null,window.location.href=t},this._array_search=function(t,e,i){var a=!!i,s="";if(e&&"object"==typeof e&&e.change_key_case)return e.search(t,i);if("object"==typeof t&&t.exec){if(!a){var o="i"+(t.global?"g":"")+(t.multiline?"m":"")+(t.sticky?"y":"");t=new RegExp(t.source,o)}for(s in e)if(t.test(e[s]))return s;return!1}for(s in e)if(a&&e[s]===t||!a&&e[s]==t)return s;return!1},this.md5=function(t){var e,i=function(t,e){return t<<e|t>>>32-e},a=function(t,e){var i,a,s,o,d;return s=2147483648&t,o=2147483648&e,i=1073741824&t,a=1073741824&e,d=(1073741823&t)+(1073741823&e),i&a?2147483648^d^s^o:i|a?1073741824&d?3221225472^d^s^o:1073741824^d^s^o:d^s^o},s=function(t,e,i){return t&e|~t&i},o=function(t,e,i){return t&i|e&~i},d=function(t,e,i){return t^e^i},r=function(t,e,i){return e^(t|~i)},n=function(t,e,o,d,r,n,h){return t=a(t,a(a(s(e,o,d),r),h)),a(i(t,n),e)},h=function(t,e,s,d,r,n,h){return t=a(t,a(a(o(e,s,d),r),h)),a(i(t,n),e)},_=function(t,e,s,o,r,n,h){return t=a(t,a(a(d(e,s,o),r),h)),a(i(t,n),e)},l=function(t,e,s,o,d,n,h){return t=a(t,a(a(r(e,s,o),d),h)),a(i(t,n),e)},g=function(t){for(var e,i=t.length,a=i+8,s=(a-a%64)/64,o=16*(s+1),d=new Array(o-1),r=0,n=0;i>n;)e=(n-n%4)/4,r=n%4*8,d[e]=d[e]|t.charCodeAt(n)<<r,n++;return e=(n-n%4)/4,r=n%4*8,d[e]=d[e]|128<<r,d[o-2]=i<<3,d[o-1]=i>>>29,d},c=function(t){var e="",i="",a,s;for(s=0;3>=s;s++)a=t>>>8*s&255,i="0"+a.toString(16),e+=i.substr(i.length-2,2);return e},p=[],u,f,w,m,v,y,b,$,C,S=7,k=12,z=17,x=22,E=5,A=9,I=14,M=20,T=4,G=11,P=16,O=23,H=6,R=10,L=15,D=21;for(t=this.utf8_encode(t),p=g(t),y=1732584193,b=4023233417,$=2562383102,C=271733878,e=p.length,u=0;e>u;u+=16)f=y,w=b,m=$,v=C,y=n(y,b,$,C,p[u+0],S,3614090360),C=n(C,y,b,$,p[u+1],k,3905402710),$=n($,C,y,b,p[u+2],z,606105819),b=n(b,$,C,y,p[u+3],x,3250441966),y=n(y,b,$,C,p[u+4],S,4118548399),C=n(C,y,b,$,p[u+5],k,1200080426),$=n($,C,y,b,p[u+6],z,2821735955),b=n(b,$,C,y,p[u+7],x,4249261313),y=n(y,b,$,C,p[u+8],S,1770035416),C=n(C,y,b,$,p[u+9],k,2336552879),$=n($,C,y,b,p[u+10],z,4294925233),b=n(b,$,C,y,p[u+11],x,2304563134),y=n(y,b,$,C,p[u+12],S,1804603682),C=n(C,y,b,$,p[u+13],k,4254626195),$=n($,C,y,b,p[u+14],z,2792965006),b=n(b,$,C,y,p[u+15],x,1236535329),y=h(y,b,$,C,p[u+1],E,4129170786),C=h(C,y,b,$,p[u+6],A,3225465664),$=h($,C,y,b,p[u+11],I,643717713),b=h(b,$,C,y,p[u+0],M,3921069994),y=h(y,b,$,C,p[u+5],E,3593408605),C=h(C,y,b,$,p[u+10],A,38016083),$=h($,C,y,b,p[u+15],I,3634488961),b=h(b,$,C,y,p[u+4],M,3889429448),y=h(y,b,$,C,p[u+9],E,568446438),C=h(C,y,b,$,p[u+14],A,3275163606),$=h($,C,y,b,p[u+3],I,4107603335),b=h(b,$,C,y,p[u+8],M,1163531501),y=h(y,b,$,C,p[u+13],E,2850285829),C=h(C,y,b,$,p[u+2],A,4243563512),$=h($,C,y,b,p[u+7],I,1735328473),b=h(b,$,C,y,p[u+12],M,2368359562),y=_(y,b,$,C,p[u+5],T,4294588738),C=_(C,y,b,$,p[u+8],G,2272392833),$=_($,C,y,b,p[u+11],P,1839030562),b=_(b,$,C,y,p[u+14],O,4259657740),y=_(y,b,$,C,p[u+1],T,2763975236),C=_(C,y,b,$,p[u+4],G,1272893353),$=_($,C,y,b,p[u+7],P,4139469664),b=_(b,$,C,y,p[u+10],O,3200236656),y=_(y,b,$,C,p[u+13],T,681279174),C=_(C,y,b,$,p[u+0],G,3936430074),$=_($,C,y,b,p[u+3],P,3572445317),b=_(b,$,C,y,p[u+6],O,76029189),y=_(y,b,$,C,p[u+9],T,3654602809),C=_(C,y,b,$,p[u+12],G,3873151461),$=_($,C,y,b,p[u+15],P,530742520),b=_(b,$,C,y,p[u+2],O,3299628645),y=l(y,b,$,C,p[u+0],H,4096336452),C=l(C,y,b,$,p[u+7],R,1126891415),$=l($,C,y,b,p[u+14],L,2878612391),b=l(b,$,C,y,p[u+5],D,4237533241),y=l(y,b,$,C,p[u+12],H,1700485571),C=l(C,y,b,$,p[u+3],R,2399980690),$=l($,C,y,b,p[u+10],L,4293915773),b=l(b,$,C,y,p[u+1],D,2240044497),y=l(y,b,$,C,p[u+8],H,1873313359),C=l(C,y,b,$,p[u+15],R,4264355552),$=l($,C,y,b,p[u+6],L,2734768916),b=l(b,$,C,y,p[u+13],D,1309151649),y=l(y,b,$,C,p[u+4],H,4149444226),C=l(C,y,b,$,p[u+11],R,3174756917),$=l($,C,y,b,p[u+2],L,718787259),b=l(b,$,C,y,p[u+9],D,3951481745),y=a(y,f),b=a(b,w),$=a($,m),C=a(C,v);var N=c(y)+c(b)+c($)+c(C);return N.toLowerCase()},this.utf8_encode=function(t){return unescape(encodeURIComponent(t))}};